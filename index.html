<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>个人动态网站</title>
  <style>
    /* 莫兰迪色系：酒红#8B2323、深黄#C19A6B、墨绿#2F4F4F */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #f5f0e6; font-family: "微软雅黑"; min-height: 100vh; }
    
    /* 左侧导航栏（7个索引栏+首页，保留滚动功能） */
    .sidebar { 
      width: 220px; height: 100vh; 
      background: #2F4F4F; color: #fff; 
      position: fixed; top: 0; left: 0;
      padding: 20px;
      overflow-y: auto; /* 垂直滚动：内容超出时显示滚动条 */
      overflow-x: hidden; /* 隐藏水平滚动条 */
      scrollbar-width: thin; /* Firefox滚动条美化 */
      scrollbar-color: #C19A6B #3A5F5F; /* 滚动条颜色（深黄滑块+墨绿背景） */
    }
    /* Chrome/Edge/Safari滚动条美化 */
    .sidebar::-webkit-scrollbar {
      width: 6px; /* 滚动条宽度 */
    }
    .sidebar::-webkit-scrollbar-track {
      background: #3A5F5F; /* 滚动条轨道颜色 */
    }
    .sidebar::-webkit-scrollbar-thumb {
      background-color: #C19A6B; /* 滚动条滑块颜色（匹配莫兰迪深黄） */
      border-radius: 3px; /* 滑块圆角 */
    }

    .sidebar h2 { 
      color: #C19A6B; margin-bottom: 30px; 
      text-align: center; border-bottom: 1px solid #C19A6B;
      padding-bottom: 10px;
    }
    .menu-item { 
      padding: 12px; margin: 10px 0; 
      background: #3A5F5F; border-radius: 6px; 
      cursor: pointer; transition: 0.3s;
    }
    .menu-item:hover { background: #8B2323; }
    .menu-item.active { background: #8B2323; }
    .back-btn {
      margin-top: 20px; padding: 10px;
      background: #C19A6B; color: #fff;
      border: none; border-radius: 6px;
      cursor: pointer; width: 100%;
      margin-bottom: 10px; /* 避免按钮贴滚动条 */
    }

    /* 主内容区 */
    .main { 
      margin-left: 220px; padding: 30px;
    }
    .header { 
      text-align: center; margin-bottom: 40px;
      color: #8B2323;
    }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
    .header p { color: #2F4F4F; font-size: 1.1rem; }

    /* 通用卡片样式 */
    .card { 
      background: #fff; padding: 25px; 
      border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .card h3 { 
      color: #8B2323; margin-bottom: 20px;
      border-left: 4px solid #C19A6B; padding-left: 10px;
    }
    textarea { 
      width: 100%; height: 120px; padding: 12px;
      border: 1px solid #C19A6B; border-radius: 6px;
      margin-bottom: 15px; resize: vertical;
    }
    .input-group { margin-bottom: 15px; }
    .input-group input { 
      width: 100%; padding: 10px;
      border: 1px solid #C19A6B; border-radius: 6px;
    }
    .btn { 
      padding: 10px 20px; border: none; 
      border-radius: 6px; cursor: pointer;
      margin-right: 10px;
    }
    .btn-primary { background: #8B2323; color: #fff; }
    .btn-secondary { background: #C19A6B; color: #fff; }
    .btn-danger { background: #dc3545; color: #fff; }

    /* 动态/文章/评论列表 */
    .list-item { 
      padding: 20px; border-bottom: 1px solid #eee;
      margin-bottom: 15px;
    }
    .list-item:last-child { border-bottom: none; }
    .list-item .meta { 
      color: #666; font-size: 0.9rem;
      margin-bottom: 10px;
    }
    .list-item .content { line-height: 1.6; color: #333; }
    .action-btn { margin-top: 10px; }

    /* 密码输入框 */
    .password-input { margin: 10px 0; }
    /* 隐藏元素 */
    .hidden { display: none; }

    /* 全局平滑滚动 */
    html {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body>
  <!-- 左侧导航栏（首页+7个有名称的索引栏） -->
  <div class="sidebar">
    <h2>WOW</h2>
    <div class="menu-item active" data-id="home" data-name="首页">首页</div>
    <div class="menu-item" data-id="1" data-name="杠十细胞">杠十细胞</div>
    <div class="menu-item" data-id="2" data-name="清风">清风</div>
    <div class="menu-item" data-id="3" data-name="过往云烟">过往云烟</div>
    <div class="menu-item" data-id="4" data-name="星月夜">星月夜</div>
    <div class="menu-item" data-id="5" data-name="竞选CCF主席">竞选CCF主席</div>
    <div class="menu-item" data-id="6" data-name="鼻子">鼻子</div>
    <div class="menu-item" data-id="7" data-name="金牌教练之死">金牌教练之死</div>
    <button class="back-btn hidden" id="backBtn">返回</button>
  </div>

  <!-- 主内容区 -->
  <div class="main">
    <!-- 首页（发布动态） -->
    <div id="homePage" class="page">
      <div class="header">
        <h1>SAR暗网</h1>
        <p>最近一次更新:2025/12/10</p>
      </div>

      <!-- 发布动态 -->
      <div class="card">
        <h3>interesting</h3>
        <textarea id="dynamicContent" placeholder="..."></textarea>
        <div class="password-input">
          <input type="password" id="dynamicPassword" placeholder="输入密码（xzr110101100）">
        </div>
        <button class="btn btn-primary" id="publishDynamicBtn">发布</button>
        <div id="dynamicMsg" style="margin-top: 10px; color: #8B2323;"></div>
      </div>

      <!-- 动态列表 -->
      <div class="card">
        <h3>好玩的</h3>
        <div id="dynamicList"></div>
      </div>
    </div>

    <!-- 文章页面（7个索引栏共用） -->
    <div id="articlePage" class="page hidden">
      <div class="header">
        <h1 id="articleTitle">杠十细胞</h1>
      </div>

      <!-- 发布/编辑文章 -->
      <div class="card">
        <h3>发布</h3>
        <textarea id="articleContent" placeholder="..."></textarea>
        <div class="password-input">
          <input type="password" id="articlePassword" placeholder="密码（xzr110101100）">
        </div>
        <button class="btn btn-primary" id="publishArticleBtn">保存</button>
        <div id="articleMsg" style="margin-top: 10px; color: #8B2323;"></div>
      </div>

      <!-- 文章内容展示 -->
      <div class="card" id="articleContentDisplay"></div>

      <!-- 文章评论区 -->
      <div class="card">
        <h3>评论区</h3>
        <div class="input-group">
          <input type="text" id="articleCommentNickname" placeholder="输入文曲星大名">
        </div>
        <textarea id="articleCommentContent" placeholder="天青色等烟雨，评论区等你..."></textarea>
        <div class="password-input">
          <input type="password" id="articleCommentPassword" placeholder="密码（xzr110101100）">
        </div>
        <button class="btn btn-primary" id="publishArticleCommentBtn">发布</button>
        <div id="articleCommentMsg" style="margin-top: 10px; color: #8B2323;"></div>
        <div id="articleCommentList" style="margin-top: 20px;"></div>
      </div>
    </div>
  </div>

  <!-- 加载LeanCloud国际版兼容的SDK（unpkg海外节点更稳定） -->
  <script src="https://unpkg.com/leancloud-storage@4.19.0/dist/av-min.js"></script>
  <script>
    // ===================== LeanCloud国际版配置（请确认以下信息是你的国际版信息） =====================
    const APP_ID = "Q21VZoZKN2avZM9vwmcBAF6W-MdYXbMMI"; // 你的国际版App ID
    const APP_KEY = "CFQrfORUFrboNxT9Xc5SHriw"; // 你的国际版App Key
    // 国际版serverURL规则：https://{你的App ID}.api.lncldglobal.com（请核对是否正确）
    const SERVER_URL = `https://${APP_ID.split('-')[0]}.api.lncldglobal.com`; 
    // ==============================================================================================

    // 全局标记：是否成功初始化LeanCloud
    let leanCloudInited = false;
    // 本地临时存储（备用：当LeanCloud不可用时，用localStorage存储数据）
    let useLocalStorage = false;

    // 初始化LeanCloud国际版（添加超时和错误处理）
    async function initLeanCloud() {
      try {
        if (typeof AV === 'undefined') {
          throw new Error('LeanCloud SDK未加载');
        }

        // 初始化国际版
        AV.init({
          appId: APP_ID,
          appKey: APP_KEY,
          serverURL: SERVER_URL
        });

        // 验证是否能连接到国际版（执行一个简单的查询，超时5秒）
        const testQuery = new AV.Query('_User');
        testQuery.limit(1);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
        await testQuery.find({ signal: controller.signal });
        clearTimeout(timeoutId);

        leanCloudInited = true;
        console.log('LeanCloud国际版初始化并验证成功');
      } catch (err) {
        console.error('LeanCloud国际版初始化失败：', err);
        console.warn('将切换到本地存储模式（数据保存在浏览器中，刷新后不会丢失）');
        useLocalStorage = true;
      }
    }

    // 定义数据表/本地存储工具
    let Dynamic, Article, Comment;
    // 本地存储键名前缀
    const STORAGE_PREFIX = 'sar_darkweb_';

    // 本地存储工具类（模拟LeanCloud的核心方法）
    class LocalStorageModel {
      constructor(type) {
        this.type = type;
        this.key = `${STORAGE_PREFIX}${type}`;
      }

      // 获取所有数据
      find() {
        const data = localStorage.getItem(this.key);
        return data ? JSON.parse(data) : [];
      }

      // 根据ID获取数据
      get(id) {
        const list = this.find();
        return list.find(item => item.id === id) || null;
      }

      // 保存数据（新增/更新）
      save(item) {
        const list = this.find();
        if (item.id) {
          // 更新
          const index = list.findIndex(i => i.id === item.id);
          if (index > -1) {
            list[index] = { ...list[index], ...item, updatedAt: new Date().toISOString() };
          }
        } else {
          // 新增
          const newItem = {
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            ...item,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            isProtected: false
          };
          list.push(newItem);
        }
        localStorage.setItem(this.key, JSON.stringify(list));
        return this.get(item.id || list[list.length - 1].id);
      }

      // 删除数据
      destroy(id) {
        let list = this.find();
        list = list.filter(item => item.id !== id);
        localStorage.setItem(this.key, JSON.stringify(list));
      }

      // 根据条件查询（简化版，支持indexId和targetType/targetId）
      findByCondition(condition) {
        const list = this.find();
        return list.filter(item => {
          for (const key in condition) {
            if (item[key] !== condition[key]) {
              return false;
            }
          }
          return true;
        });
      }
    }

    const PASSWORD_PUBLISH = "xzr110101100";
    const PASSWORD_PROTECT = "Czmxzr20091228"; 

    let currentArticleId = 1;
    let currentArticleName = "杠十细胞";

    // 页面初始化主逻辑
    document.addEventListener('DOMContentLoaded', async () => {
      // 第一步：初始化LeanCloud国际版
      await initLeanCloud();

      // 第二步：初始化数据模型（LeanCloud / 本地存储）
      if (leanCloudInited) {
        Dynamic = AV.Object.extend('Dynamic');
        Article = AV.Object.extend('Article');
        Comment = AV.Object.extend('Comment');
      } else {
        Dynamic = new LocalStorageModel('dynamic');
        Article = new LocalStorageModel('article');
        Comment = new LocalStorageModel('comment');
      }

      // 第三步：绑定索引栏点击事件（优先执行，确保能切换）
      bindMenuClick();

      // 第四步：绑定按钮事件
      bindButtonEvents();

      // 第五步：加载首页动态
      loadDynamics();
    });

    // 绑定索引栏点击事件
    function bindMenuClick() {
      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', () => {
          // 切换active样式
          document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');

          const id = item.dataset.id;
          const name = item.dataset.name;

          if (id === 'home') {
            // 切换到首页
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('articlePage').classList.add('hidden');
            document.getElementById('backBtn').classList.add('hidden');
            loadDynamics();
          } else {
            // 切换到文章页面
            currentArticleId = id;
            currentArticleName = name;
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('articlePage').classList.remove('hidden');
            document.getElementById('articleTitle').textContent = name;
            document.getElementById('backBtn').classList.remove('hidden');
            loadArticle(id);
            loadComments('article', id);
          }
        });
      });

      // 返回按钮事件
      document.getElementById('backBtn').addEventListener('click', () => {
        document.querySelector('.menu-item[data-id="home"]').click();
      });
    }

    // 绑定按钮事件
    function bindButtonEvents() {
      document.getElementById('publishDynamicBtn').addEventListener('click', publishDynamic);
      document.getElementById('publishArticleBtn').addEventListener('click', publishArticle);
      document.getElementById('publishArticleCommentBtn').addEventListener('click', () => {
        publishComment('article', currentArticleId);
      });
    }

    // ------------------------ 动态相关功能（兼容LeanCloud/本地存储） ------------------------
    async function loadDynamics() {
      const listEl = document.getElementById('dynamicList');
      listEl.innerHTML = '<p>加载中...</p>';

      try {
        let dynamics = [];
        if (leanCloudInited) {
          // LeanCloud逻辑：按时间倒序查询
          const query = new AV.Query(Dynamic);
          query.descending('createdAt');
          dynamics = await query.find();
          dynamics = dynamics.map(item => ({ ...item.toJSON(), id: item.id }));
        } else {
          // 本地存储逻辑：按时间倒序查询
          dynamics = Dynamic.find().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        listEl.innerHTML = '';
        if (dynamics.length === 0) {
          listEl.innerHTML = '<p>暂无动态，快来发布第一条吧！</p>';
          return;
        }

        // 渲染动态列表
        dynamics.forEach(dynamic => {
          const item = document.createElement('div');
          item.className = 'list-item';
          item.innerHTML = `
            <div class="meta">发布时间：${formatTime(dynamic.createdAt)}</div>
            <div class="content">${dynamic.content}</div>
            <div class="action-btn">
              <button class="btn btn-secondary" onclick="loadComments('dynamic', '${dynamic.id}', this)">查看评论</button>
              <button class="btn btn-${dynamic.isProtected ? 'secondary' : 'danger'}" onclick="toggleProtect('dynamic', '${dynamic.id}', ${dynamic.isProtected || false})">
                ${dynamic.isProtected ? '取消保护' : '保护'}
              </button>
              ${!dynamic.isProtected ? `<button class="btn btn-danger" onclick="deleteDynamic('${dynamic.id}')">删除</button>` : ''}
            </div>
            <div class="comment-area hidden" id="comment-dynamic-${dynamic.id}" style="margin-top: 20px;">
              <div class="input-group">
                <input type="text" class="comment-nickname" placeholder="请输入昵称">
              </div>
              <textarea class="comment-content" placeholder="请输入评论内容..."></textarea>
              <div class="password-input">
                <input type="password" class="comment-password" placeholder="请输入评论密码（${PASSWORD_PUBLISH}）">
              </div>
              <button class="btn btn-primary" onclick="publishComment('dynamic', '${dynamic.id}', this)">发布评论</button>
              <div class="comment-list" id="comment-list-dynamic-${dynamic.id}"></div>
            </div>
          `;
          listEl.appendChild(item);
        });
      } catch (err) {
        console.error('加载动态失败：', err);
        listEl.innerHTML = `<p>加载失败：${err.message}（功能已切换到本地存储）</p>`;
      }
    }

    async function publishDynamic() {
      const content = document.getElementById('dynamicContent').value.trim();
      const password = document.getElementById('dynamicPassword').value.trim();
      const msgEl = document.getElementById('dynamicMsg');

      // 校验
      if (!content) {
        msgEl.textContent = '没货啊（请输入动态内容）';
        return;
      }
      if (password !== PASSWORD_PUBLISH) {
        msgEl.textContent = '乐子（密码错误，正确密码：${PASSWORD_PUBLISH}）';
        return;
      }

      try {
        let dynamicData = { content, isProtected: false };
        if (leanCloudInited) {
          // LeanCloud发布
          const dynamic = new Dynamic();
          dynamic.set(dynamicData);
          await dynamic.save();
        } else {
          // 本地存储发布
          Dynamic.save(dynamicData);
        }

        // 提示并刷新
        msgEl.textContent = '嘿嘿（发布成功）';
        document.getElementById('dynamicContent').value = '';
        document.getElementById('dynamicPassword').value = '';
        loadDynamics();
      } catch (err) {
        console.error('发布动态失败：', err);
        msgEl.textContent = `发布失败：${err.message}`;
      }
    }

    async function deleteDynamic(dynamicId) {
      if (!confirm('若是精华，建议勿删')) return;
      const password = prompt('请输入密码（删除动态）');
      if (password !== PASSWORD_PUBLISH) {
        alert('乐子（密码错误）');
        return;
      }

      try {
        // 检查是否被保护
        let dynamic;
        if (leanCloudInited) {
          const query = new AV.Query(Dynamic);
          dynamic = await query.get(dynamicId);
          if (dynamic.get('isProtected')) {
            alert('你不配（动态已被保护，无法删除）');
            return;
          }
          // 删除动态
          await dynamic.destroy();
          // 删除关联评论
          const commentQuery = new AV.Query(Comment);
          commentQuery.equalTo('targetType', 'dynamic');
          commentQuery.equalTo('targetId', dynamicId);
          const comments = await commentQuery.find();
          await AV.Object.destroyAll(comments);
        } else {
          dynamic = Dynamic.get(dynamicId);
          if (dynamic && dynamic.isProtected) {
            alert('你不配（动态已被保护，无法删除）');
            return;
          }
          // 删除动态
          Dynamic.destroy(dynamicId);
          // 删除关联评论
          const comments = Comment.findByCondition({ targetType: 'dynamic', targetId: dynamicId });
          comments.forEach(comment => Comment.destroy(comment.id));
        }

        alert('动态删除成功！');
        loadDynamics();
      } catch (err) {
        console.error('删除动态失败：', err);
        alert(`删除失败：${err.message}`);
      }
    }

    // ------------------------ 文章相关功能（兼容LeanCloud/本地存储） ------------------------
    async function loadArticle(indexId) {
      const contentEl = document.getElementById('articleContent');
      const displayEl = document.getElementById('articleContentDisplay');
      displayEl.innerHTML = '<p>加载中...</p>';

      try {
        let article = null;
        if (leanCloudInited) {
          // LeanCloud查询
          const query = new AV.Query(Article);
          query.equalTo('indexId', Number(indexId));
          const articles = await query.find();
          if (articles.length > 0) {
            article = { ...articles[0].toJSON(), id: articles[0].id };
          }
        } else {
          // 本地存储查询
          const articles = Article.findByCondition({ indexId: Number(indexId) });
          article = articles.length > 0 ? articles[0] : null;
        }

        if (article) {
          contentEl.value = article.content;
          displayEl.innerHTML = `
            <div class="list-item">
              <div class="meta">最后更新：${formatTime(article.updatedAt)}</div>
              <div class="content">${article.content}</div>
              <div class="action-btn">
                <button class="btn btn-${article.isProtected ? 'secondary' : 'danger'}" onclick="toggleProtect('article', '${article.id}', ${article.isProtected || false})">
                  ${article.isProtected ? '取消保护' : '保护'}
                </button>
                ${!article.isProtected ? `<button class="btn btn-danger" onclick="deleteArticle('${article.id}', ${indexId})">删除</button>` : ''}
              </div>
            </div>
          `;
        } else {
          contentEl.value = '';
          displayEl.innerHTML = '<p>暂无文章，快来发布第一篇吧！</p>';
        }
      } catch (err) {
        console.error('加载文章失败：', err);
        displayEl.innerHTML = `<p>加载失败：${err.message}（功能已切换到本地存储）</p>`;
      }
    }

    async function publishArticle() {
      const content = document.getElementById('articleContent').value.trim();
      const password = document.getElementById('articlePassword').value.trim();
      const msgEl = document.getElementById('articleMsg');

      // 校验
      if (!content) {
        msgEl.textContent = '虚了？（请输入文章内容）';
        return;
      }
      if (password !== PASSWORD_PUBLISH) {
        msgEl.textContent = '乐子（密码错误，正确密码：${PASSWORD_PUBLISH}）';
        return;
      }

      try {
        if (leanCloudInited) {
          // LeanCloud保存：查询是否已有文章
          const query = new AV.Query(Article);
          query.equalTo('indexId', Number(currentArticleId));
          const articles = await query.find();

          let article;
          if (articles.length > 0) {
            // 更新
            article = articles[0];
            article.set('content', content);
          } else {
            // 新建
            article = new Article();
            article.set('indexId', Number(currentArticleId));
            article.set('content', content);
            article.set('isProtected', false);
          }
          await article.save();
        } else {
          // 本地存储保存：查询是否已有文章
          const articles = Article.findByCondition({ indexId: Number(currentArticleId) });
          if (articles.length > 0) {
            // 更新
            Article.save({ id: articles[0].id, content });
          } else {
            // 新建
            Article.save({ indexId: Number(currentArticleId), content });
          }
        }

        msgEl.textContent = '文章保存成功！';
        loadArticle(currentArticleId);
      } catch (err) {
        console.error('保存文章失败：', err);
        msgEl.textContent = `保存失败：${err.message}`;
      }
    }

    async function deleteArticle(articleId, indexId) {
      if (!confirm('手滑了吗')) return;
      const password = prompt('请输入密码（删除文章）');
      if (password !== PASSWORD_PUBLISH) {
        alert('乐子（密码错误）');
        return;
      }

      try {
        // 检查是否被保护
        let article;
        if (leanCloudInited) {
          const query = new AV.Query(Article);
          article = await query.get(articleId);
          if (article.get('isProtected')) {
            alert('该文章已被保护，无法删除！');
            return;
          }
          // 删除文章
          await article.destroy();
          // 删除关联评论
          const commentQuery = new AV.Query(Comment);
          commentQuery.equalTo('targetType', 'article');
          commentQuery.equalTo('targetId', String(indexId));
          const comments = await commentQuery.find();
          await AV.Object.destroyAll(comments);
        } else {
          article = Article.get(articleId);
          if (article && article.isProtected) {
            alert('该文章已被保护，无法删除！');
            return;
          }
          // 删除文章
          Article.destroy(articleId);
          // 删除关联评论
          const comments = Comment.findByCondition({ targetType: 'article', targetId: String(indexId) });
          comments.forEach(comment => Comment.destroy(comment.id));
        }

        alert('文章删除成功！');
        loadArticle(indexId);
      } catch (err) {
        console.error('删除文章失败：', err);
        alert(`删除失败：${err.message}`);
      }
    }

    // ------------------------ 评论相关功能（兼容LeanCloud/本地存储） ------------------------
    async function loadComments(targetType, targetId, btnEl) {
      let listEl;
      // 切换评论区显示/隐藏
      if (btnEl) {
        const commentArea = btnEl.parentElement.querySelector(`#comment-${targetType}-${targetId}`);
        if (!commentArea) return;
        commentArea.classList.toggle('hidden');
        if (commentArea.classList.contains('hidden')) return;
        listEl = commentArea.querySelector('.comment-list');
      } else {
        listEl = document.getElementById('articleCommentList');
      }

      listEl.innerHTML = '<p>加载中...</p>';

      try {
        let comments = [];
        if (leanCloudInited) {
          // LeanCloud查询
          const query = new AV.Query(Comment);
          query.equalTo('targetType', targetType);
          query.equalTo('targetId', String(targetId));
          query.descending('createdAt');
          comments = await query.find();
          comments = comments.map(item => ({ ...item.toJSON(), id: item.id }));
        } else {
          // 本地存储查询
          comments = Comment.findByCondition({ targetType, targetId: String(targetId) })
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        listEl.innerHTML = '';
        if (comments.length === 0) {
          listEl.innerHTML = '<p>快来抢沙发！</p>';
          return;
        }

        // 渲染评论
        comments.forEach(comment => {
          listEl.innerHTML += `
            <div class="list-item">
              <div class="meta">${comment.nickname} · ${formatTime(comment.createdAt)}</div>
              <div class="content">${comment.content}</div>
              <div class="action-btn">
                <button class="btn btn-${comment.isProtected ? 'secondary' : 'danger'}" onclick="toggleProtect('comment', '${comment.id}', ${comment.isProtected || false})">
                  ${comment.isProtected ? '取消保护' : '保护'}
                </button>
                ${!comment.isProtected ? `<button class="btn btn-danger" onclick="deleteComment('${comment.id}', '${targetType}', '${targetId}')">删除</button>` : ''}
              </div>
            </div>
          `;
        });
      } catch (err) {
        console.error('加载评论失败：', err);
        listEl.innerHTML = `<p>加载失败：${err.message}</p>`;
      }
    }

    async function publishComment(targetType, targetId, btnEl) {
      // 获取输入内容
      let nickname, content, password;
      let commentArea;
      if (targetType === 'dynamic') {
        commentArea = btnEl.parentElement;
        nickname = commentArea.querySelector('.comment-nickname').value.trim();
        content = commentArea.querySelector('.comment-content').value.trim();
        password = commentArea.querySelector('.comment-password').value.trim();
      } else {
        nickname = document.getElementById('articleCommentNickname').value.trim();
        content = document.getElementById('articleCommentContent').value.trim();
        password = document.getElementById('articleCommentPassword').value.trim();
      }

      // 校验
      if (!nickname || !content) {
        alert('虚了？（请输入昵称和评论内容）');
        return;
      }
      if (password !== PASSWORD_PUBLISH) {
        alert('乐子（密码错误）');
        return;
      }

      try {
        const commentData = {
          targetType,
          targetId: String(targetId),
          nickname,
          content,
          isProtected: false
        };

        if (leanCloudInited) {
          // LeanCloud发布
          const comment = new Comment();
          comment.set(commentData);
          await comment.save();
        } else {
          // 本地存储发布
          Comment.save(commentData);
        }

        alert('评论发布成功！');
        // 清空输入框
        if (targetType === 'dynamic') {
          commentArea.querySelector('.comment-nickname').value = '';
          commentArea.querySelector('.comment-content').value = '';
          commentArea.querySelector('.comment-password').value = '';
        } else {
          document.getElementById('articleCommentNickname').value = '';
          document.getElementById('articleCommentContent').value = '';
          document.getElementById('articleCommentPassword').value = '';
        }
        // 刷新评论
        loadComments(targetType, targetId, btnEl);
      } catch (err) {
        console.error('发布评论失败：', err);
        alert(`发布失败：${err.message}`);
      }
    }

    async function deleteComment(commentId, targetType, targetId) {
      if (!confirm('是吗')) return;
      const password = prompt('请输入密码（删除评论）');
      if (password !== PASSWORD_PUBLISH) {
        alert('密码错误！');
        return;
      }

      try {
        // 检查是否被保护
        let comment;
        if (leanCloudInited) {
          const query = new AV.Query(Comment);
          comment = await query.get(commentId);
          if (comment.get('isProtected')) {
            alert('略略略~（评论已被保护）');
            return;
          }
          await comment.destroy();
        } else {
          comment = Comment.get(commentId);
          if (comment && comment.isProtected) {
            alert('略略略~（评论已被保护）');
            return;
          }
          Comment.destroy(commentId);
        }

        alert('评论删除成功！');
        loadComments(targetType, targetId);
      } catch (err) {
        console.error('删除评论失败：', err);
        alert(`删除失败：${err.message}`);
      }
    }

    // ------------------------ 保护/取消保护功能 ------------------------
    async function toggleProtect(type, id, isProtectedNow) {
      const newStatus = !isProtectedNow;
      const password = prompt(`请输入${newStatus ? '保护' : '取消保护'}密码`);
      if (password !== PASSWORD_PROTECT) {
        alert('乐子（密码错误）');
        return;
      }

      try {
        if (leanCloudInited) {
          // LeanCloud更新状态
          let query;
          switch (type) {
            case 'dynamic': query = new AV.Query(Dynamic); break;
            case 'article': query = new AV.Query(Article); break;
            case 'comment': query = new AV.Query(Comment); break;
            default: alert('类型错误！'); return;
          }
          const obj = await query.get(id);
          obj.set('isProtected', newStatus);
          await obj.save();
        } else {
          // 本地存储更新状态
          let model;
          switch (type) {
            case 'dynamic': model = Dynamic; break;
            case 'article': model = Article; break;
            case 'comment': model = Comment; break;
            default: alert('类型错误！'); return;
          }
          const obj = model.get(id);
          if (obj) {
            model.save({ id, isProtected: newStatus });
          }
        }

        alert(`${newStatus ? '保护' : '取消保护'}成功！`);
        // 刷新数据
        if (type === 'dynamic') loadDynamics();
        else if (type === 'article') loadArticle(currentArticleId);
        else loadComments('article', currentArticleId);
      } catch (err) {
        console.error('保护操作失败：', err);
        alert(`操作失败：${err.message}`);
      }
    }

    // ------------------------ 工具函数 ------------------------
    function formatTime(timeStr) {
      if (!timeStr) return '';
      const date = new Date(timeStr);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
  </script>
</body>
</html>
